# oblychaizer

## Основные принципы и архитектура работы скрипта

### Общая архитектура

Система состоит из двух основных компонентов: **Parser** и **Daemon**, взаимодействующих через общую очередь IP-адресов.

---

### Parser (парсер) — поток/процесс

- Периодически загружает/скрейпит бесплатные ресурсы (списки IP/URL).
- Парсит IP-адреса и сохраняет их:
  - В файл `ip_list.txt`
  - В общую очередь `ip_queue` (в памяти)
- Выполняет **дедупликацию** при добавлении.

---

### Daemon (демон) — главный процесс

Загружает `ip_queue` в память и управляет проверками. Работает **многопоточно**:

- **Worker pool** — пул потоков, которые параллельно:
  - Пробуют подключиться к IP
  - Проверяют пинг, скорость, потерю пакетов

- **Monitor thread** — следит за текущими активными подключениями (`alive`):
  - Регулярно проверяет их параметры
  - При падении качества переключает на следующий `alive` сервер

- **Reaper / Retry thread** — управляет `await_list`:
  - Периодически ре-тестирует серверы из ожидания
  - Использует экспоненциальный бэкофф

---

### Хранилища

- `ip_queue` — очередь необработанных IP (в памяти, подкреплена файлом `ip_list.txt`)
- `alive[]` — массив структур активных серверов (с метриками, сокетом/сессией)
- `await_list` — очередь/счётчик для серверов с плохими метриками (в ожидании)

---

### Библиотеки и инструменты (рекомендуемые)

| Назначение                     | Инструмент / Библиотека         |
|-------------------------------|----------------------------------|
| Сетевые запросы (парсинг)     | `libcurl` (HTTP GET, таймауты)  |
| Пинг (ICMP)                   | `liboping` или raw-сокеты       |
| Альтернатива ICMP (без root)  | `getaddrinfo` + TCP `connect()` |
| Многопоточность               | `pthread`                       |
| Синхронизация                 | `pthread_mutex`, `pthread_cond` |
| Асинхронный I/O               | `epoll` (Linux), `poll`/`select`|
| JSON/HTML парсинг             | `jsmn` или строковые функции    |
| Логирование                   | `syslog` или файл с ротацией    |

---

### Формат структуры данных (пример)

```c
typedef enum { STATE_NEW, STATE_CHECKING, STATE_ALIVE, STATE_AWAIT } ip_state_t;

typedef struct {
    char ip[64];             // "1.2.3.4" или "2001:db8::1"
    int port;                // порт для проверки (1194, 443, 51820 и т.д.)
    ip_state_t state;
    double rtt_ms;           // средний RTT
    double packet_loss;      // % потерянных пакетов
    double throughput_kbps;  // измеренная пропускная способность (эвристика)
    time_t last_checked;
    int fail_count;          // для backoff
    // возможно: socket fd, session id и т.д.
} vpn_server_t;

```
